<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link rel="stylesheet" type="text/css" href="./stylesheets/app.css">
    <link rel="stylesheet" type="text/css" href="./stylesheets/list.css">
    <link rel="stylesheet" type="text/css" href="./stylesheets/list_card.css">
    <link rel="stylesheet" type="text/css" href="./stylesheets/members.css">
    <link rel="stylesheet" type="text/css" href="./stylesheets/card.css">
    <link rel="stylesheet" type="text/css" href="./stylesheets/comment.css">
    <link rel="stylesheet" type="text/css" href="./stylesheets/add_card.css">
  </head>

  <body>
    <div id="App"></div>
  </body>

  <script type="text/jsx">
    import React from 'react'
    import ReactDOM from 'react-dom'
    import ss from 'slack-signaler'
    import webrtc from './webrtc'
    import Tesseract from 'tesseract'

    let doc_id = 98765
    let token = process.env.SLACK_BOT_TOKEN
    let bot = ss.init({doc_id: doc_id, bot_token: token })
    
    window.PEERS = []
    
    webrtc.on('disconnect', (peer) => {
      console.log("Disconnect for",peer.id)
      window.PEERS.splice(window.PEERS.indexOf(peer))
    })

    webrtc.on('connect', (peer) => {
      window.PEERS.push(peer)
      peer.on('message', (m) => {
        if (m.deltas) {
          if (m.deltas.length > 0) {
            app.state.store.dispatch({type: "APPLY_DELTAS", deltas: m.deltas})
          }
        }
        if (m.vectorClock) {
          let deltas = Tesseract.getDeltasAfter(app.state.store.getState(), m.vectorClock)
          let reply = {
            vectorClock: Tesseract.getVClock(app.state.store.getState()), 
            deltas: deltas.slice(0, 5) // just send up to five deltas at a time
          }
          peer.send(reply)
        }
      })

      peer.send({vectorClock: Tesseract.getVClock(app.state.store.getState())})
    })
    webrtc.join(bot)

    const render = () => {
      const App = require('./components/app').default
      ReactDOM.render(<App />, document.getElementById('App'))
    }

    render()
  </script>
</html>
